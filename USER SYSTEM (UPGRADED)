def validate_password(password: str):
    """Return (True, 'OK') or (False, reason)."""
    if len(password) < 8:
        return False, "Password must be at least 8 characters."
    if not re.search(r"[a-z]", password):
        return False, "Password must include a lowercase letter."
    if not re.search(r"[A-Z]", password):
        return False, "Password must include an uppercase letter."
    if not re.search(r"\d", password):
        return False, "Password must include a digit."
    if not re.search(r"[^\w\s]", password):
        return False, "Password must include a special character (e.g., !@#$%)."
    return True, "OK"

def hash_password_pbkdf2(password: str, salt: bytes, iterations: int = 200_000) -> bytes:
    return hashlib.pbkdf2_hmac("sha256", password.encode("utf-8"), salt, iterations)

def init_users():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    # Updated schema: username + role + salt + pw_hash
    c.execute("""
    CREATE TABLE IF NOT EXISTS users (
        username TEXT PRIMARY KEY,
        role TEXT NOT NULL,
        salt BLOB NOT NULL,
        pw_hash BLOB NOT NULL
    )
    """)
    conn.commit()

    # Seed accounts (idempotent)
    seed = [
        ("admin", "Admin123!", "admin"),
        ("student1", "Student123!", "user"),
        ("student2", "Student123!", "user"),
        ("student3", "Student123!", "user"),
    ]

    for username, password, role in seed:
        c.execute("SELECT username FROM users WHERE username=?", (username,))
        if c.fetchone():
            continue
        salt = secrets.token_bytes(16)
        pw_hash = hash_password_pbkdf2(password, salt)
        c.execute("INSERT INTO users (username, role, salt, pw_hash) VALUES (?,?,?,?)",
                  (username, role, salt, pw_hash))

    conn.commit()
    conn.close()

def login():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    u = input("Username: ").strip()
    p = input("Password: ")

    c.execute("SELECT role, salt, pw_hash FROM users WHERE username=?", (u,))
    row = c.fetchone()
    conn.close()

    if not row:
        print("Invalid login.")
        return None, None

    role, salt, stored_hash = row
    candidate_hash = hash_password_pbkdf2(p, salt)

    if secrets.compare_digest(candidate_hash, stored_hash):
        print("Login successful.")
        return u, role
    else:
        print("Invalid login.")
        return None, None

def signup():
    """Create a new user account and store it in SQLite."""
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    print("\nCreate Account")
    u = input("Choose a username: ").strip()
    if not u:
        print("Username cannot be empty.")
        conn.close()
        return

    c.execute("SELECT username FROM users WHERE username=?", (u,))
    if c.fetchone():
        print("That username already exists. Please log in.")
        conn.close()
        return

    print("Password rules: min 8 chars + uppercase + lowercase + digit + special char.")
    p = input("Choose a password: ")
    ok, msg = validate_password(p)
    if not ok:
        print("Password rejected:", msg)
        conn.close()
        return

    p2 = input("Confirm password: ")
    if p2 != p:
        print("Passwords do not match.")
        conn.close()
        return

    salt = secrets.token_bytes(16)
    pw_hash = hash_password_pbkdf2(p, salt)

    # normal users by default
    c.execute("INSERT INTO users (username, role, salt, pw_hash) VALUES (?,?,?,?)",
              (u, "user", salt, pw_hash))
    conn.commit()
    conn.close()
    print("Account created successfully. You can log in now.")

def change_password(username: str):
    """Allow the logged-in user to change their own password."""
    print("\nChange Password")
    new_pw = input("New password: ")
    ok, msg = validate_password(new_pw)
    if not ok:
        print("Password rejected:", msg)
        return

    confirm = input("Confirm new password: ")
    if confirm != new_pw:
        print("Passwords do not match.")
        return

    salt = secrets.token_bytes(16)
    pw_hash = hash_password_pbkdf2(new_pw, salt)

    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute("UPDATE users SET salt=?, pw_hash=? WHERE username=?", (salt, pw_hash, username))
    conn.commit()
    conn.close()
    print("Password updated successfully.")
