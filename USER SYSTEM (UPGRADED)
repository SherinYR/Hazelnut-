from typing_extensions import NoDefault
import sqlite3
import hashlib
import secrets
import re
import os

DB_FILE = "users.db"


# Password rules

def validate_password_rules(password: str):
    if len(password) < 8:
        return False, "At least 8 characters required"
    if not re.search(r"[a-z]", password):
        return False, "Must contain lowercase letter"
    if not re.search(r"[A-Z]", password):
        return False, "Must contain uppercase letter"
    if not re.search(r"\d", password):
        return False, "Must contain a digit"
    if not re.search(r"[^\w\s]", password):
        return False, "Must contain special character"
    return True, "OK"


def hash_password(password: str, salt: bytes) -> bytes:
    return hashlib.pbkdf2_hmac("sha256", password.encode(), salt, 200_000)


#DB init (self-healing) 

def init_db():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    c.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        salt BLOB NOT NULL,
        pw_hash BLOB NOT NULL,
        is_admin INTEGER NOT NULL DEFAULT 0
    )
    """)
    conn.commit()

    # Seed admin (idempotent)
    c.execute("SELECT username FROM users WHERE username='admin'")
    if not c.fetchone():
        salt = secrets.token_bytes(16)
        pw_hash = hash_password("Admin123!", salt)
        c.execute(
            "INSERT INTO users (username, salt, pw_hash, is_admin) VALUES (?,?,?,1)",
            ("admin", salt, pw_hash),
        )

    conn.commit()
    conn.close()


# Signup

def signup():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    print("\n=== Create Account ===")
    username = input("Username: ").strip()

    c.execute("SELECT username FROM users WHERE username=?", (username,))
    if c.fetchone():
        print("Username already exists")
        conn.close()
        return

    password = input("Password: ")
    ok, msg = validate_password_rules(password)
    if not ok:
        print(NoDefault, msg)
        conn.close()
        return

    confirm = input("Confirm password: ")
    if confirm != password:
        print("Passwords do not match")
        conn.close()
        return

    salt = secrets.token_bytes(16)
    pw_hash = hash_password(password, salt)

    c.execute(
        "INSERT INTO users (username, salt, pw_hash, is_admin) VALUES (?,?,?,0)",
        (username, salt, pw_hash),
    )
    conn.commit()
    conn.close()

    print("Account created successfully")


#Login

def login():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()

    print("\n=== Login ===")
    username = input("Username: ").strip()
    password = input("Password: ")

    c.execute("SELECT salt, pw_hash, is_admin FROM users WHERE username=?", (username,))
    row = c.fetchone()
    conn.close()

    if not row:
        print("Invalid username or password")
        return None

    salt, stored_hash, is_admin = row
    candidate = hash_password(password, salt)
    
    print(f' Debug: {password}')
    print(f' Debug: {candidate}')

    if secrets.compare_digest(candidate, stored_hash):
        print("Login successful")
        print("Role:", "ADMIN" if is_admin else "USER")
        return username, bool(is_admin)
    else:
        print("Invalid username or password")
        return None


# Runner

def run_login_demo():
    init_db()

    while True:
        print("\n1) Login")
        print("2) Create account")
        print("3) Exit")
        choice = input("Choose: ").strip()

        if choice == "1":
            login()
        elif choice == "2":
            signup()
        elif choice == "3":
            print("Goodbye")
            break
        else:
            print("Invalid choice")


run_login_demo()
